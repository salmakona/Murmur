<template>

  <div>
         <main role="main" class="container">
      <div class="my-3 p-3 bg-white rounded box-shadow">
        <h6 class="border-bottom border-gray pb-2 mb-0">Recent updates</h6>
        <div class="media text-muted pt-3">
          <img data-src="holder.js/32x32?theme=thumb&amp;bg=007bff&amp;fg=007bff&amp;size=1" alt="32x32" class="mr-2 rounded" style="width: 32px; height: 32px;" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2232%22%20height%3D%2232%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2032%2032%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_17666ef4032%20text%20%7B%20fill%3A%23007bff%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A2pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_17666ef4032%22%3E%3Crect%20width%3D%2232%22%20height%3D%2232%22%20fill%3D%22%23007bff%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2212.296875%22%20y%3D%2216.9%22%3E32x32%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" data-holder-rendered="true">
          <p class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray">
            <strong class="d-block text-gray-dark">@username</strong>
            Donec id elit non mi porta gravida at eget metus. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus.
          </p>
        </div>
      </div>

      <div class="my-3 p-3 bg-white rounded box-shadow">
        <h6 class="border-bottom border-gray pb-2 mb-0">Suggestions</h6>
        <div class="media text-muted pt-3">
          <img data-src="holder.js/32x32?theme=thumb&amp;bg=007bff&amp;fg=007bff&amp;size=1" alt="32x32" class="mr-2 rounded" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2232%22%20height%3D%2232%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2032%2032%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_17666ef4038%20text%20%7B%20fill%3A%23007bff%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A2pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_17666ef4038%22%3E%3Crect%20width%3D%2232%22%20height%3D%2232%22%20fill%3D%22%23007bff%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2212.296875%22%20y%3D%2216.9%22%3E32x32%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" data-holder-rendered="true" style="width: 32px; height: 32px;">
          <div class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray">
            <div class="d-flex justify-content-between align-items-center w-100">
              <strong class="text-gray-dark">Full Name</strong>
              <a href="#">Follow</a>
            </div>
            <span class="d-block">@username</span>
          </div>
        </div>
        <div class="media text-muted pt-3">
          <img data-src="holder.js/32x32?theme=thumb&amp;bg=007bff&amp;fg=007bff&amp;size=1" alt="32x32" class="mr-2 rounded" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2232%22%20height%3D%2232%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2032%2032%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_17666ef4039%20text%20%7B%20fill%3A%23007bff%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A2pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_17666ef4039%22%3E%3Crect%20width%3D%2232%22%20height%3D%2232%22%20fill%3D%22%23007bff%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2212.296875%22%20y%3D%2216.9%22%3E32x32%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" data-holder-rendered="true" style="width: 32px; height: 32px;">
          <div class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray">
            <div class="d-flex justify-content-between align-items-center w-100">
              <strong class="text-gray-dark">Full Name</strong>
              <a href="#">Follow</a>
            </div>
            <span class="d-block">@username</span>
          </div>
        </div>
        <div class="media text-muted pt-3">
          <img data-src="holder.js/32x32?theme=thumb&amp;bg=007bff&amp;fg=007bff&amp;size=1" alt="32x32" class="mr-2 rounded" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2232%22%20height%3D%2232%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2032%2032%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_17666ef403a%20text%20%7B%20fill%3A%23007bff%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A2pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_17666ef403a%22%3E%3Crect%20width%3D%2232%22%20height%3D%2232%22%20fill%3D%22%23007bff%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2212.296875%22%20y%3D%2216.9%22%3E32x32%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" data-holder-rendered="true" style="width: 32px; height: 32px;">
          <div class="media-body pb-3 mb-0 small lh-125 border-bottom border-gray">
            <div class="d-flex justify-content-between align-items-center w-100">
              <strong class="text-gray-dark">Full Name</strong>
              <a href="#">Follow</a>
            </div>
            <span class="d-block">@username</span>
          </div>
        </div>
        <small class="d-block text-right mt-3">
          <a href="#">All suggestions</a>
        </small>
      </div>
    </main>
    <div>
      <img src="/iconfinder_user-alt_285645.png" />
    </div>
    <div>
      <p class="text-uppercase">{{full_name}}</p>
      <p class="text-lowercase">@{{user_name}}</p>
      <p class="text-justify"> {{about_me}}</p>
      <h6>Followers <span class="badge badge-secondary">{{this.followersCount}}</span></h6>
      <h6>Following <span class="badge badge-secondary">{{this.followingcount}}</span></h6>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="inputFrom">
          <form action="" method="post" @submit.prevent="submitForm()">
            <div class="form-group">
              <textarea class="form-control" v-model="tweet" @click="callEvent" placeholder="What happening...."
                rows="3"></textarea>
              <div class="error" v-if="error">
                <p class="text-danger"> {{ errors_msg }}</p>
              </div>
            </div>
            <input type="submit" value="Post" class="btn btn-dark button">
          </form>
        </div>

      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h1>Want to follow</h1>
        <div>
          <ul v-for="list in list" v-bind:key="list.id" v-bind:id="list.id">
            <nuxt-link :to="'user-profile/' + list.id">
              <li class="left"><img src="/iconfinder_user-alt_285645.png" />
                <span>{{list.full_name}}</span>
              </li>
            </nuxt-link>
            <h6><span class="badge badge-dark" @click="follow(list.id)">Follow</span></h6>
          </ul>
          <div v-if="error_follower">{{this.errorMessage_follwer}}</div>
        </div>

      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h1>Following</h1>
        <div>
          <ul v-for="following in following" v-bind:key="following.id" v-bind:id="following.id">
            <nuxt-link :to="'user-profile/' + following.id">
              <li class="left"><img src="/iconfinder_user-alt_285645.png" />
                <span>{{following.full_name}}</span>
              </li>
            </nuxt-link>
            <h6><span class="badge badge-dark" @click="follow(following.id)">Unfollow </span></h6>
          </ul>
          <div v-if="error">{{this.errorMessage}}</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="card">
          <ul class="list-group list-group-flush" v-for="timeline_murmur in timeline_murmur"
            v-bind:key="timeline_murmur.id" v-bind:id="timeline_murmur.id">
            {{timeline_murmur.full_name}} -@{{timeline_murmur.user_name}}
            <li class="list-group-item">
              <nuxt-link :to="'murmur-detail/' + timeline_murmur.id">
                {{timeline_murmur.murmur_content.substring(0,100)+".."}}
              </nuxt-link>
              </li>

            <h6><span class="badge badge-dark" @click="likePost(timeline_murmur.id)">Like</span> <span
                class="badge badge-secondary">{{timeline_murmur.like_count}}</span></h6>
          </ul>
         <nav aria-label="Page navigation example">
          <ul class="pagination">
            <li class="page-item"> 
              <button type="button" name="button1" class="btn btn-primary" @click="previousPage()" :disabled="disable == 'false'">Previous</button>
            </li>
             <li class="page-item"> 
                  <button type="button" name="button2" class="btn btn-primary" @click="nextPage()" :disabled="next_status_disable == 'true'">Start</button>
             </li>
            <!-- <li class="page-item"  @click="previousPage()"><a class="page-link">Previous</a></li> -->
            <!-- <li class="page-item" @click="nextPage()" :disabled="status == 'false'"><a class="page-link">Next</a></li> -->
          
          
          </ul>
        </nav>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
  import axios from "axios";
  import moment from 'moment';
  export default {
    data() {
      return {
        tweet: '',
        error: false,
        errors_msg: '',
        timeline_murmur: [],
        list: [],
        user: [],
        user_name: '',
        full_name: '',
        about_me: '',
        join_date: '',
        followersCount: [],
        followingcount: [],
        following: [],
        date: '',
        userId: 1,
        button_active: false,
        error: false,
        errorMessage: '',
        error_follower: false,
        errorMessage_follwer: '',
        page: 1,
        next_status_disable: '',
        disable:''
      }
    },
    async created() {
      try {

        const list = await axios.get('http://localhost:3001/api/user/notfollowing/' + this.userId)
            this.list = list.data;
            console.log("follower  exits =========")
            console.log(this.list)
            this.error_follower = false
            this.errorMessage_follwer = "";
          console.log("SAlma "+list.data)
       
      } catch (err) {
         console.log("follower not exits =========")
          this.error_follower = true
          this.errorMessage_follwer = "user not exits...";
          this.list = [];
          console.log(err)
      }

      // murmurs for timeline 
      try {

        const resAll = await axios.get('http://localhost:3001/api/murmurs/timeline/' + this.userId+'/'+this.page);
        this.timeline_murmur = resAll.data
        this.disable = false

      } catch (err) {}
      try {
        const resUser = await axios.get('http://localhost:3001/api/user/' + this.userId)

        this.user = resUser.data[0]
        console.log(this.user)
        this.user_name = this.user.user_name,
          this.full_name = this.user.full_name,
          this.about_me = this.user.about_me,
          this.join_date = this.user.join_date

      } catch (err) {

      }
      try {

        const resFollowerCount = await axios.get('http://localhost:3001/api/followerCount/' + this.userId);
        console.log("Folowed count")
        this.followersCount = resFollowerCount.data.count

      } catch (err) {

      }

      try {
        const resFollowedBYCount = await axios.get('http://localhost:3001/api/followingCount/' + this.userId);
        console.log("Followingcount" + resFollowedBYCount.data)

        this.followingcount = resFollowedBYCount.data.count

      } catch (err) {

      }

      //getFollowing users
      try {
        const resFollowing = await axios.get('http://localhost:3001/api/following/' + this.userId);
        this.following = resFollowing.data;
        this.error = false
        this.errorMessage = "";
        console.log("Following not exits=========" + resFollowing.data)

      } catch (err) {
          console.log("Following not exits=========")
          this.error = true
          this.errorMessage = "user not exits...";
          this.following = [];
      }

    },
    methods: {
      callEvent() {
        console.log("Event called");
        this.error = false

      },
      async likePost(mumur_id, userId) {
        console.log("mumur_id: " + mumur_id + "user_id: " + this.userId)
        const res = await axios.post('http://localhost:3001/api/murmurs/like', {
            user_id: this.userId,
            mumur_id: mumur_id
          })
          .then((response) => {
            console.log(response);
            this.refresh()
          });
      },
      async follow(followId) {
        console.log("follower_user_id: " + followId + "user_id: " + this.userId)
        const res = await axios.post('http://localhost:3001/api/follower', {
          user_id: this.userId,
          follower_user_id: followId
        }).then((response) => {
          console.log(response);
          this.followerReload();
          this.followingReload();
          this.refresh()
        });

      },
      async getInfo(userId) {
        const resUserinfo = await axios.get('http://localhost:3001/api/user/' + this.userId)
        this.user = resUserinfo.data[0]
        console.log(this.user)
        this.user_name = this.user.user_name,
          this.full_name = this.user.full_name,
          this.about_me = this.user.about_me,
          this.join_date = this.user.join_date

      },
      async submitForm() {
        const config = {
          headers: {
            Accept: "application/json"
          }
        };
        console.log("Clicked");
        console.log(this.tweet)
        const body = {
          murmur_content: this.tweet,
          user_id: "1",
          like_count: 0,
          creation_date: "2020-12-14 1.5.30"
        }
        console.log(body);
        if (this.tweet == '') {
          console.log("tweet is missing !!!");
          this.error = true;
          this.errors_msg = "Murmur is missing"
        } else {
          const res = await axios.post('http://localhost:3001/api/murmur', {
              user_id: "1",
              murmur_content: this.tweet,
              like_count: 0,
              creation_date: "2020-12-14 1.5.30"
            })
            .then((response) => {
              console.log(response);
              this.refresh()
            });
        }
      },
      async refresh() {
        // murmurs for timeline 
        try {

          const resAll = await axios.get('http://localhost:3001/api/murmurs/timeline/' + this.userId);
          this.timeline_murmur = resAll.data

        } catch (err) {}
      },
      async followerReload() {
        try {

          const list = await axios.get('http://localhost:3001/api/user/notfollowing/' + this.userId);
          this.list = list.data;
          console.log("follower=========" + list.data)
          console.log(this.list);
          this.error_follower = false
          this.errorMessage_follwer = "";
          console.log("SAlma "+list.data)
        } catch (err) {
          console.log("follower=========")
          this.error_follower = true
          this.errorMessage_follwer = "user not exits...";
          this.list = [];
          console.log("SAlmaHHHHH "+err)
        }

      },

      async followingReload() {
        // 
        try {
          const resFollowing = await axios.get('http://localhost:3001/api/following/' + this.userId);
          console.log("Following=========" + resFollowing.data)
          this.following = resFollowing.data
          this.error = false
          this.errorMessage = "";
        } catch (err) {
          console.log("Following=========")
          this.error = true
          this.errorMessage = "user not exits...";
          this.following = [];
        }
      },
      async nextPage() {
          
             try {
                 this.page += 1;
            console.log("nextPage" + this.page);
            const resAll = await axios.get('http://localhost:3001/api/murmurs/timeline/' + this.userId+'/'+this.page);
            this.timeline_murmur = resAll.data;
            console.log(this.timeline_murmur.count);
            } catch (err) {
              console.log(err)
              this.next_status_disable = 'true'
             
            }
        },
        async previousPage() {
            if(this.page > 1) {
                this.page -= 1;
                console.log("previousPage" + this.page)
            }
            if(this.page == 1) {
              this.page = 1;
              //this.next_status_disable = ''
              this.disable = false
            }
            try {
            const resAll = await axios.get('http://localhost:3001/api/murmurs/timeline/' + this.userId+'/'+this.page);
            this.timeline_murmur = resAll.data
            } catch (err) {
              console.log(err)
              //this.next_status_disable = ''
              this.disable = false
            }
            
        }

    }


  }

</script>

<style scoped>
  .murmur {
    padding: 1rem;
    border: 1px dotted #ccc;
    margin: 1rem 0;
  }

  .inputFrom {
    padding: 10px;

  }

  .textArea {
    width: 100%;
  }

  .button {
    float: right;
  }

  .heading {
    width: 250px;

  }

  .left {
    float: left;
  }

</style>
